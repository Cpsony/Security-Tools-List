http://www.pentest-standard.org/index.php/Post_Exploitation


内容
1 目的
2 参与规则
2.1 保护客户
2.2 保护自己
3 基础设施分析
3.1 网络配置
3.1.1 接口
3.1.2 路由
3.1.3 DNS服务器
3.1.4 缓存的DNS条目
3.1.5 代理服务器
3.1.6 ARP条目
3.2 网络服务
3.2.1 听力服务
3.2.2 VPN连接
3.2.3 目录服务
3.2.4 邻居
4 掠夺
4.1 已安装的程序
4.1.1 启动项
4.2 已安装的服务
4.2.1 安全服务
4.2.2 文件/打印机共享
4.2.3 数据库服务器
4.2.4 目录服务器
4.2.5 名称服务器
4.2.6 部署服务
4.2.7 证书颁发机构
4.2.8 源代码管理服务器
4.2.9 动态主机配置服务器
4.2.10 虚拟化
4.2.11 消息传递
4.2.12 监测和管理
4.2.13 备份系统
4.2.14 网络服务（RADIUS，TACACS..etc）
4.3 敏感数据
4.3.1 密钥记录
4.3.2 屏幕截图
4.3.3 网络流量捕获
4.3.4 以前的审计报告
4.4 用户信息
4.4.1 在系统上
4.4.2 Web浏览器
4.4.3 IM客户端
4.5 系统配置
4.5.1 密码策略
4.5.2 安全策略
4.5.3 配置的无线网络和密钥
5 高价值/配置目标
6 数据泄露
6.1 所有可能的渗透路径的映射
6.2 测试渗出路径
6.3 测量控制强度
7 持久性
8 进一步渗透基础设施
8.1 来自妥协的系统
8.2 通过妥协系统
9 清理
目的
后利用阶段的目的是确定受损机器的价值并保持对机器的控制以供以后使用。机器的价值取决于存储在其上的数据的灵敏度以及机器在进一步危及网络方面的有用性。此阶段中描述的方法旨在帮助测试人员识别和记录敏感数据，识别配置设置，通信信道以及与可用于进一步访问网络的其他网络设备的关系，并设置一个或多个方法。稍后访问机器。如果这些方法与商定的交战规则不同，则必须遵守“交战规则”。

参与规则
以下“参与规则”特定于渗透测试的剥削后阶段，旨在确保客户的系统不会受到测试人员（直接或间接）行为的不必要风险，并确保双方商定的程序在项目的后期开发阶段遵循。

保护客户
以下规则将用作与客户建立规则的指南，以确保客户的日常运营和数据不会面临风险：

除非事先达成一致，否则客户不会对其基础设施认为“关键”的服务进行修改。修改此类服务的目的是向客户演示攻击者可能如何：
升级特权
获取对特定数据的访问权限
导致拒绝服务
必须记录针对系统执行的所有修改，包括配置更改。完成修改的预期目的后，如果可能，应将所有设置返回到其原始位置。在订婚之后，应该向客户提供更改列表，以允许他们确保所有更改都已正确撤消。无法返回原始位置的变更应与成功撤销的变更明确区分开来。
必须保留针对受损系统采取的详细操作列表。清单应包括所采取的行动及其发生的时间段。完成后，该清单应作为最终报告的附录。
在渗透测试过程中发现的任何和所有私人和/或个人用户数据（包括密码和系统历史记录）可用作获取进一步权限的杠杆，或仅在满足以下条件时执行与测试相关的其他操作：
客户端的“可接受使用策略”声明所有系统都归客户端所有，存储在这些系统上的所有数据都是客户端的属性。
可接受使用策略声明与客户端网络的连接被视为同意搜索和分析连接的计算机（包括所有当前数据和配置）。
客户确认所有员工已阅读并理解“可接受使用政策”。
密码（包括加密形式的密码）将不会包含在最终报告中，或者必须进行足够的屏蔽以确保报告的收件人无法重新创建或猜测密码。这样做是为了保护密码所属用户的机密性，以及维护他们保护的系统的完整性。
未经客户事先书面同意，可能无法实施任何用于维护对受感染系统的访问并且可能影响系统正常运行或其移除可能导致停机的方法或设备。
用于维护对受感染系统的访问的任何方法或设备必须采用某种形式的用户认证，例如数字证书或登录提示。与已知受控系统的反向连接也是可接受的。
测试人员收集的所有数据必须在测试人员使用的系统上加密。
报告中包含的任何可能包含敏感数据的信息（屏幕截图，表格，图形）必须使用使报告的收件人永久无法恢复的技术进行清理或屏蔽。
收到的所有数据将在客户接受最终报告后销毁。将向客户提供使用的方法和销毁证明。
如果收集的数据受任何法律管辖，则所使用的系统及其位置将由客户提供，以确保收集和处理的数据不违反任何适用法律。如果系统将是渗透测试团队的系统，则可能无法下载数据并将其存储到其系统中，并且仅显示访问证明（文件权限，记录计数，文件名等等）。
未经客户事先同意，不会使用第三方密码破解服务，也不会与第三方共享任何其他类型的数据。
如果在评估环境中发现先前妥协的证据，则渗透团队在评估期间记录的所有记录具有操作和时间将被保存，散列并提供给客户。然后，客户端可以确定如何最好地响应和处理事件响应。
除非客户在订立合同/工作说明书中明确授权，否则不得删除，清除或修改日志。如果已获得授权，则必须在进行任何更改之前备份日志。
保护自己
由于渗透测试的性质，您必须确保在与客户打交道时以及您将要执行的任务时涵盖所有基础。与客户讨论以下内容，以确保在开始任何工作之前清楚地了解客户和提供商的角色和职责。

确保客户和提供商签署的合同和/或工作说明表明正在测试的系统上的操作是代表客户的，并代表客户。
在开始参与之前，获取管理用户对公司系统和基础架构使用的安全策略的副本（通常称为“可接受使用”策略）。验证该政策是否涵盖：
个人使用设备和在客户系统上存储个人员工数据以及对该数据的所有权和权利。
存储在公司设备上的数据的所有权。
确认管理客户在其系统上管理和使用的数据的法规和法律以及对此类数据施加的限制。
对将接收和存储客户端数据的系统和可移动媒体使用完全驱动器加密。
与客户讨论并建立在发现第三方妥协的情况下应遵循的程序。
检查有关音频和视频捕获和/或存储的法律，因为在开发后使用此方法可能被视为违反当地或国家窃听法。
基础设施分析
网络配置
受感染机器的网络配置可用于识别其他子网，网络路由器，关键服务器，名称服务器以及机器之间的关系。此信息可用于识别其他目标，以进一步渗透客户的网络。

接口
识别计算机上的所有网络接口及其IP地址，子网掩码和网关。通过识别接口和设置，可以优先考虑网络和服务以进行定位。

路由
可以利用其他子网，过滤或寻址方案的知识来逃避分段网络，从而导致额外的主机和/或网络进行探测和枚举。这些数据可能来自特定主机或网络上的各种来源，包括：

接口
路由表，包括静态和动态路由
用于服务和主机发现的ARP表，NetBios或其他网络协议。
对于多宿主主机，请确定它们是否充当路由器。
DNS服务器
通过评估主机设置来识别正在使用的所有DNS服务器。然后，可以使用DNS服务器和信息来开发和执行用于在目标网络上发现其他主机和服务的计划。在DNS服务器遭到破坏的情况下，DNS数据库将提供有关主机和服务的有价值信息，这些信息可用于为评估的其余部分确定目标的优先级。可以使用修改和添加新记录来根据DNS拦截服务数据。

缓存的DNS条目
识别缓存中的高价值DNS条目，其中可能包括Intranet站点，管理界面或外部站点的登录页面。高速缓存接口提供被入侵主机使用的最新和最常用主机的信息，提供主机关系和交互的视图，提供可用于确定目标网络和基础设施进一步渗透的目标优先级的信息。如果允许，对缓存条目的修改可用于捕获身份验证凭据，身份验证令牌或获取有关受损主机使用的服务的进一步信息，从而进一步渗透目标网络。

代理服务器
识别网络和应用程序级代理服务器。当客户端在企业范围内使用时，代理服务器成为良好的目标。在应用程序代理的情况下，可以识别，修改和/或监视流量流量或流量本身。代理攻击通常是向客户显示影响和风险的有效手段。

ARP条目
枚举缓存和静态ARP表条目，这些条目可以显示与受感染机器交互的其他主机。静态ARP条目可能代表关键机器。如果评估范围允许拦截和修改ARP条目，则很容易以通常未检测到或受到保护的方式显示中断，监视或危害服务的可能性。

网络服务
听力服务
识别目标计算机提供的所有网络服务。这可能导致发现未通过初始扫描识别的服务以及其他机器和网络的发现。扫描中未示出的服务的识别还可以提供关于在网络和/或主机中实现的可能的过滤和控制系统的信息。此外，测试人员可能能够利用这些服务来破坏其他机器。大多数操作系统包括识别进出机器的TCP和UDP连接的方法。通过检查与受感染机器之间的连接和从受感染机器的连接，可以找到以前未知的关系。除主持人外，还应考虑服务，

VPN连接
应识别进出目标机器或网络的所有VPN连接。出站连接可以提供到之前未被识别的新系统的路径。入站和出站都可以识别新系统和可能的业务关系。VPN连接通常会绕过防火墙和入侵检测/防御系统，因为它们无法解密或检查加密流量。这一事实使VPN成为发起攻击的理想选择。在针对它们发起攻击之前，应该在范围内验证任何新目标。目标主机上存在VPN客户端或服务器连接还可以提供对先前未知的可用于定位其他主机和服务的凭证的访问。

目录服务
目标主机运行目录服务可以提供枚举可以用于其他攻击的用户帐户，主机和/或服务的机会，或者提供在漏洞分析阶段中可能以前未发现的其他目标。此外，目录服务中的用户详细信息可用于社交工程和网络钓鱼活动攻击，从而提供更高的成功率。

邻居
在当今的网络中，许多服务和操作系统使用许多协议进行邻居发现，以使服务的访问，故障排除和配置更加方便。协议取决于目标主机的类型。网络设备可以使用诸如CDP（思科发现协议）和LLDP（链路层发现协议）之类的协议来向直接连接到它们或存在于同一子网中的主机识别系统，配置和其他细节。类似地，桌面和服务器操作系统可以使用诸如mDNS（多播域名服务）和NetBios之类的协议来查找同一子网中的主机和服务的细节。

抢劫
掠夺是指从与预评估阶段中定义的目标相关的目标主机获取信息（即包含个人信息，信用卡信息，密码等的文件）。可以获得该信息以满足目标或作为枢转过程的一部分以获得对网络的进一步访问。此数据的位置将根据数据类型，主机角色和其他情况而有所不同。熟悉并熟悉常用应用程序，服务器软件和中间件非常重要，因为大多数应用程序以多种不同的格式和位置存储数据。可能需要特殊工具来从某些系统获取，提取或读取目标数据。

已安装的程序
启动项目
大多数系统都具有可以在系统启动或用户登录时运行的应用程序，这些应用程序可以提供有关系统，软件和服务交互的信息。该信息可能揭示可能存在的可能阻碍进一步利用目标网络及其系统的潜在对策（例如HIDS / HIPS，应用白名单，FIM）。应收集的信息包括：

系统上安装的应用程序及其关联版本的列表。
应用于系统的操作系统更新列表。
已安装的服务
特定主机上的服务可以为主机本身或目标网络中的其他主机提供服务。有必要创建每个目标主机的配置文件，注意这些服务的配置，它们的目的，以及它们如何可能用于实现评估目标或进一步渗透网络。

安全服务
安全服务包括旨在使攻击者远离系统并保持数据安全的软件。这些包括但不限于网络防火墙，基于主机的防火墙，IDS / IPS，HIDS / HIPS和防病毒。识别单个目标主机上的任何安全服务可以了解在定位网络中的其他计算机时会发生什么。它还可以了解在测试期间可能触发的警报，可以在项目汇报期间与客户讨论，并可能导致更新安全策略，UAC，SELinux，IPSec，Windows安全模板或其他安全性规则集/配置。

文件/打印机共享
文件和打印服务器通常包含目标数据或提供进一步渗透目标网络和主机的机会。应针对的信息包括：

文件服务器提供的共享 - 应检查目标系统提供的任何文件共享。即使只是股票的名称和评论也可能泄漏有关内部应用程序或项目名称的重要信息（即，只有“Fred”和“Christine”可以访问“Accounting”文件夹，也许他们都是会计员工）。
访问控制列表和共享权限。 - 从客户端，如果可以连接到共享，则应检查连接是否为只读或读/写。请记住，如果共享包含目录，则不同的权限可能适用于不同的目录。从服务器端，应检查服务器配置和文件/目录权限。
文件共享文件和内容列表
从文件共享列表中识别感兴趣的文件。寻找有趣或有针对性的项目，例如：
源代码
备份
安装文件
机密数据（电子表格中的财务数据，TXT / PDF中的银行报告，密码文件等）
放置特洛伊木马或自动运行文件 - 使用聪明的命名，或模仿已经使用的命名约定，可以鼓励用户执行这些有效负载，使测试人员能够进一步穿透网络。如果可以获取文件服务器日志，则甚至可以针对特定用户。
数据库服务器
数据库包含可能在评估中定位的大量信息。

数据库 - 数据库名称列表可以帮助评估者确定数据库的用途以及数据库可能包含的数据类型。在具有许多数据库的环境中，这将有助于确定目标的优先级。
表 - 表名和元数据（如注释，列名和类型）也可以帮助评估者选择目标并查找目标数据。
表内容，受监管内容的行数
列 - 在许多数据库中，可以使用单个命令搜索所有表的所有列名。这可以被利用来查找目标数据（例如，如果信用卡数据是针对在Oracle数据库上，尝试执行SELECT * FROM ALL_TAB_COLUMNS其中名称=“％CCN％”; 。
数据库和表权限
数据库用户，密码，组和角色
托管在数据库上的信息还可用于显示风险，实现评估目标，确定服务的配置和功能，或进一步渗透客户端网络和主机。

目录服务器
目录服务的主要目标是向服务和主机提供信息以供参考或/和身份验证。此服务的妥协可以允许控制依赖于服务的所有主机，并提供可用于进一步攻击的信息。要在目录服务中查找的信息是：

对象列表（用户，密码，机器等）
与系统的连接
协议和安全级别的标识
名称服务器
名称服务器根据其服务器的记录类型为主机和服务提供解析。记录和控制的枚举可以提供目标和服务的列表，以优先化和攻击以进一步渗透客户端网络和主机。修改和添加记录的能力可用于显示拒绝服务的风险以及帮助拦截客户网络上的流量和信息。

部署服务
部署服务的标识允许访问和枚举：

无人参与的答案文件
文件权限
包括更新
应用程序和版本
此信息可用于进一步渗透客户端网络和主机。修改存储库和服务配置的能力允许

后门安装
修改服务以使其易受攻击
证书颁发机构
在受感染的客户端主机上标识证书颁发机构服务将允许访问

根CA.
代码签名证书
加密和签名证书
控制服务也将允许

为多个任务创建新证书
撤销证书
修改证书撤销清单
插入根CA证书
对服务的控制显示出风险，并允许客户网络和主机上的数据和服务受到损害。

源代码管理服务器
通过在受感染主机或服务的客户端部分上运行的服务来识别源代码管理系统提供了以下机会：

枚举项目 - 项目名称可以提供有关公司项目的敏感信息。
验证对源代码文件的访问权限
修改源代码文件 - 如果允许在范围内，则修改源代码可以证明攻击者可以进行会影响系统的更改
枚举开发人员 - 开发人员的详细信息可用于社交工程攻击，也可用作攻击系统其他区域的输入
枚举配置
动态主机配置服务器
通过受感染主机识别动态主机配置服务或使用服务允许：

列举租约给出
枚举配置
枚举选项
修改配置
消费所有租约
对服务的控制可用于显示拒绝服务的风险以及在受损网络上的主机和服务的中间攻击中用于人的风险。

虚拟化
标识虚拟化服务或客户端软件允许：

枚举虚拟机（名称，配置，操作系统）
枚举管理系统的密码和数字证书。
枚举虚拟化软件配置
主机配置
通过控制VM状态显示拒绝服务的风险
访问VM上托管的数据
拦截受感染主机上托管的虚拟主机或服务的流量
消息
识别用于消息传递的服务或客户端软件提供了机会

识别目录服务
凭证妥协
访问机密信息
识别网络上的主机
系统和业务关系
所有这些信息和操作都可用于显示风险并进一步渗透客户的网络和主机。

监测和管理
为了监视和/或管理而识别服务或客户端软件可以提供目标网络上的附加服务器和服务的标识，此外，获得的配置参数可以提供对其他目标主机的访问并且确定由测试者执行的操作。可以被客户检测到。一些服务要寻找：

SNMP（简单网络管理协议）
系统日志
要查找获取凭据，识别主机并获得对其他服务的访问权的某些管理服务和软件可能是：

SSH服务器/客户端
Telnet服务器/客户端
RDP（远程桌面协议）客户端
终端服务器
虚拟环境管理软件
备份系统
为备份数据而识别服务或客户端软件为攻击者提供了一个很好的机会，因为这些系统需要访问他们需要备份的数据和系统，从而为攻击者提供：

主机和系统的枚举
列举服务
主机和/或服务的凭据
访问备份数据
从服务中获得的信息可用于显示系统及其信息的机密性，完整性和访问风险。访问备份还可以提供将未命中配置，易受攻击的软件或后门引入客户端系统的机会。

网络服务（RADIUS，TACACS..etc）
识别服务或使用网络服务允许：

枚举用户
主机和系统的枚举
凭证妥协
如果不存在替代方法，则显示拒绝服务的风险
敏感数据
按键记录
通过监控击键，可以检测包括密码和PII在内的敏感信息 - 如果用户在私人IM上聊天同时使用公司软件，不知道这是什么的合法性，谁都知道？如果公司说可以监控网络上的所有数据，那么这应该没问题。如果存在“保护自己”中的第二个要点并指出可以监控设备的使用并且不允许个人使用，如果政策不涵盖个人用户或数据所有权，则不会。它应该扩展到覆盖网络。

屏幕截图
屏幕捕获可用于显示妥协的证据以及对屏幕上显示的信息的访问以及通过其他方式访问的信息是不可能的。通过屏幕捕获收集的数据应该非常小心，以便也不显示客户客户的员工的私人数据。

网络流量捕获
可以使用网络流量捕获，具体取决于网络上的控制，用于捕获的介质可用于：

识别网络上的主机
拦截数据
识别服务
识别网络中主机之间的关系
获取凭证
应注意仅捕获参与范围内的流量，并且捕获的信息不受当地法律的控制，如捕获IP语音呼叫。应过滤保留和显示的信息，以保护客户的客户和/或员工个人和机密数据。

以前的审计报告
用户信息
在本节中，主要关注目标系统上存在的与用户帐户相关的信息，这些信息存在于系统上或远程连接并留下一些痕迹，执行评估的人员可以收集和分析以进一步渗透或提供期望的评估目标。

在系统上
可以在受感染系统上收集的一般信息包括：

历史文件 - 历史文件存储用户执行的最近命令。通过这些读取可以揭示系统配置信息，重要应用程序，数据位置和其他系统*敏感信息。
加密密钥（SSH，PGP / GPG）
有趣的文档（.doc / x，.xls / x，密码。*） - 用户经常将密码和其他敏感信息存储在明文文档中。这些可以通过两种方式定位，即搜索文件名以查找有趣的单词，例如password.txt，或搜索文档本身。索引服务可以为此提供帮助，例如Linux locate数据库。
用户特定应用配置参数
单个应用程序历史记录（仅限MRU Windows，历史文件..等）
枚举可移动媒体
枚举网络共享/域权限（gpresult）
Web浏览器
可以从Web浏览器收集的信息可用于识别其他主机和系统，以及提供进一步渗透客户端网络和主机的信息：

浏览器历史
书签
下载历史
证书
代理
插件/扩展
应特别注意只有参与范围内的数据才能被捕获，因为来自Web浏览器的信息可能包含客户的员工机密和私人数据。应从返回的数据和报告中过滤此数据。

IM客户端
可以从受感染系统上的IM客户端收集的信息是：

枚举帐户配置（用户，密码，服务器，代理）
聊天记录
应特别注意只有参与范围内的数据才能被捕获，因为来自Web浏览器的信息可能包含客户的员工机密和私人数据。应从返回的数据和报告中过滤此数据。

系统配置
密码政策
通过枚举系统密码策略，暴力破解和破解密码的能力变得更加高效，例如，知道最小密码长度为8个字符，您可以从字典中删除少于8个字符的任何单词。

安全政策
配置的无线网络和密钥
通过查找目标无线信息，可以在现场通过公司wifi发起物理攻击。它还可以允许设置假AP以引诱目标在远离站点时进行连接。

高价值/配置目标
通过分析从受损系统收集的数据以及这些系统与其上运行的服务之间的相互作用，可以识别并从参与前会议中确定的目标进一步扩展高价值/概况目标。这些高价值/概况目标的操作和交互有助于识别和衡量企业可以对数据和流程以及客户基础设施和服务的整体完整性产生的影响。

数据泄露
映射所有可能的渗出路径
从已实现访问的每个区域，应创建完整的渗出路径。这包括进入外部世界的二级和三级方式（通过不同的可访问子网等）。提供映射后，应开始实际的渗透测试。

测试渗出路径
根据exfiltration路径映射，数据应该从被测试的组织中渗透出来。这应该已经包含在预先参与范围内，并且应该设置适当的基础设施，这些基础设施应该遵守客户可接受的参与策略（即，在完全控制测试人员的情况下，被泄露的数据通常被泄露到服务器，并且将访问和拥有对被测试组织的权利）。渗透本身应模拟与威胁建模标准相对应的威胁参与者使用的真实世界渗透策略 与组织相关（即，如果犯罪主要是“标准”渗透使用网络内部的暂存区域，其中数据存档在zip / 7z加密文件内，然后发送到互联网上的FTP / HTTP服务器，如果更复杂的威胁演员那么使用模拟这种用于渗透的策略和策略的手段）。

测量控制强度
在执行exfiltration测试时，测试的主要目标是查看当前用于检测和阻止敏感信息离开组织的控件是否实际工作，以及如果检测到任何响应团队的反应，则执行响应团队此类警报以及如何调查和减轻事件。

坚持
安装需要身份验证的后门程序。
安装和/或修改服务以连接回系统。用户和复杂密码应至少使用; 在可能的情况下，首选使用证书或加密密钥。（SSH，ncat，RDP）。可以使用限于单个IP的反向连接。
使用复杂密码创建备用帐户。
如果可能，后门必须在重新启动后继续存在。
进一步渗透基础设施
透视是测试人员利用其在受感染系统上的存在来进一步枚举和访问客户端基础结构上的其他系统的操作。可以使用本地资源或上载到受感染系统的工具从受感染的主机执行此操作。

从妥协系统
可以从受损系统中采取的操作：

上传工具
使用本地系统工具
ARP扫描
Ping Sweep
DNS内部网络的枚举
目录服务枚举
蛮力攻击
通过管理协议和受损凭据进行枚举和管理（WinRM，WMI，SMB，SNMP ..等）
滥用受损的凭据和密钥（网页，数据库......等）
执行远程漏洞利用
将要执行的操作取决于显示特定风险和/或进一步渗透客户端网络和主机所需的信息。建议定期计划会议重新评估信息收集，并确定继续开发后的最佳方法，直到达到既定目标。

通过妥协的系统
可以通过受损系统采取的措施：

转发端口
代理到内部网络（SSH）
VPN到内部网络
执行远程漏洞利用
滥用受损的凭据和密钥（网页，数据库......等）
将要执行的操作取决于显示特定风险和/或进一步渗透客户端网络和主机所需的信息。建议定期计划会议重新评估信息收集，并确定继续开发后的最佳方法，直到达到既定目标。

清理
一旦渗透测试完成，清理过程将涵盖清理系统的要求。这将包括测试期间使用的所有用户帐户和二进制文件。

从受感染的系统中删除所有可执行文件，脚本和临时文件。如果可能，请使用安全删除方法删除文件和文件夹。
如果在评估期间修改了它们，则返回原始值系统设置和应用程序配置参数。
删除所有已安装的后门和/或rootkit。
删除为连接到折衷系统而创建的所有用户帐户。
